<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cr√©ateur de V≈ìux 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Biblioth√®que html2canvas pour capturer l'aper√ßu -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 50%, #4a69bd 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 30px;
            margin: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4a69bd;
        }

        h1 {
            color: #0c2461;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #4a69bd;
            font-size: 1.2rem;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-title {
            color: #0c2461;
            margin-bottom: 20px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
        }

        .step-title i {
            margin-right: 10px;
            background-color: #4a69bd;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voeux-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .voeux-option {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
            text-align: center;
            position: relative;
        }

        .voeux-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #4a69bd;
        }

        .voeux-option.selected {
            background-color: #e6f0ff;
            border-color: #0c2461;
        }

        .voeux-option h3 {
            color: #0c2461;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .voeux-option p {
            color: #666;
            font-size: 0.9rem;
        }

        .edit-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #4a69bd;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .edit-badge:hover {
            background-color: #0c2461;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #0c2461;
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4a69bd;
        }

        /* Container sp√©cifique pour la capture */
        .capture-container {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid #e0e0e0;
            position: relative;
            width: 100%;
            /* Fixe pour html2canvas */
            overflow: visible !important;
            transform: none !important;
        }

        /* Container visible pour l'utilisateur */
        .preview-container {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border: 1px solid #e0e0e0;
            position: relative;
            width: 100%;
        }

        .voeux-preview {
            line-height: 1.6;
            font-size: 1.1rem;
            color: #333;
            width: 100%;
            /* √âvite les probl√®mes de rendu */
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
        }

        .voeux-preview .recipient-name {
            font-weight: bold;
            color: #0c2461;
        }

        .edit-voeux-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #4a69bd;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .edit-voeux-btn:hover {
            background-color: #0c2461;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-prev {
            background-color: #f8f9fa;
            color: #0c2461;
            border: 2px solid #0c2461;
        }

        .btn-prev:hover {
            background-color: #e6f0ff;
        }

        .btn-next {
            background-color: #4a69bd;
            color: white;
        }

        .btn-next:hover {
            background-color: #0c2461;
            transform: translateY(-2px);
        }

        .btn-send {
            background-color: #25D366;
            color: white;
            margin-left: 10px;
        }

        .btn-send:hover {
            background-color: #1da851;
            transform: translateY(-2px);
        }

        .btn-download {
            background-color: #6c5ce7;
            color: white;
            margin-left: 10px;
        }

        .btn-download:hover {
            background-color: #5b4fcf;
            transform: translateY(-2px);
        }

        .btn-modify {
            background-color: #f39c12;
            color: white;
            margin-left: 10px;
        }

        .btn-modify:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }

        .btn-send:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            margin: 0 8px;
            transition: background-color 0.3s ease;
        }

        .step-dot.active {
            background-color: #0c2461;
            transform: scale(1.2);
        }

        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background-color: white;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a69bd;
        }

        .edit-modal-header h2 {
            color: #0c2461;
            font-size: 1.8rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #0c2461;
        }

        .template-edit-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .template-edit-option {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
        }

        .template-edit-option:hover {
            border-color: #4a69bd;
        }

        .template-edit-option.selected {
            background-color: #e6f0ff;
            border-color: #0c2461;
        }

        .template-edit-option h3 {
            color: #0c2461;
            margin-bottom: 10px;
        }

        .template-edit-option p {
            color: #666;
            font-size: 0.9rem;
        }

        .edit-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }

        .edit-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .edit-btn-cancel {
            background-color: #f8f9fa;
            color: #0c2461;
            border: 2px solid #0c2461;
        }

        .edit-btn-cancel:hover {
            background-color: #e6f0ff;
        }

        .edit-btn-save {
            background-color: #4a69bd;
            color: white;
        }

        .edit-btn-save:hover {
            background-color: #0c2461;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Styles sp√©cifiques pour le rendu image */
        .image-render {
            /* Styles fixes pour une meilleure capture */
            width: 800px !important;
            max-width: 800px !important;
            min-width: 800px !important;
            padding: 40px !important;
            margin: 0 auto !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .voeux-options {
                grid-template-columns: 1fr;
            }
            
            .template-edit-options {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                margin-left: 0 !important;
            }
            
            .edit-voeux-btn {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 15px;
                width: 100%;
            }
            
            /* Ajustements mobile pour la capture */
            .capture-container {
                padding: 20px;
                min-height: auto;
            }
            
            .preview-container {
                padding: 20px;
                min-height: auto;
            }
            
            .voeux-preview {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cr√©ateur de V≈ìux 2026</h1>
            <p class="subtitle">Personnalisez vos v≈ìux du Nouvel An et envoyez-les √† vos proches via WhatsApp</p>
        </header>

        <div class="step-indicator">
            <div class="step-dot active" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
            <div class="step-dot" data-step="3"></div>
        </div>

        <!-- √âtape 1 : Choix du type de v≈ìux -->
        <div id="step-1" class="step active">
            <h2 class="step-title"><i>1</i> Choisissez le type de v≈ìux</h2>
            <p style="color: #666; margin-bottom: 20px;">Cliquez sur le crayon pour modifier un mod√®le</p>
            <div class="voeux-options">
                <div class="voeux-option" data-type="familial">
                    <div class="edit-badge" data-edit-type="familial">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3>Familial & Classique</h3>
                    <p>Parfait pour la famille et les proches</p>
                </div>
                <div class="voeux-option" data-type="amical">
                    <div class="edit-badge" data-edit-type="amical">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3>Amical & Original</h3>
                    <p>Pour vos amis, ton original et chaleureux</p>
                </div>
                <div class="voeux-option" data-type="couple">
                    <div class="edit-badge" data-edit-type="couple">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3>Romantique</h3>
                    <p>Pour votre partenaire, doux et √©mouvant</p>
                </div>
                <div class="voeux-option" data-type="professionnel">
                    <div class="edit-badge" data-edit-type="professionnel">
                        <i class="fas fa-edit"></i>
                    </div>
                    <h3>Professionnel</h3>
                    <p>Pour vos coll√®gues et relations professionnelles</p>
                </div>
            </div>
            <div class="buttons">
                <div></div> <!-- Empty div for spacing -->
                <button id="next-1" class="btn btn-next">Suivant <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <!-- √âtape 2 : Entrer le nom et personnaliser -->
        <div id="step-2" class="step">
            <h2 class="step-title"><i>2</i> Personnalisez vos v≈ìux</h2>
            <div class="form-group">
                <label for="recipient-name">Nom du destinataire :</label>
                <input type="text" id="recipient-name" placeholder="Ex: Marie, Jean, la famille Dupont..." maxlength="50">
            </div>
            <div class="form-group">
                <label for="custom-message">Message personnalis√© (optionnel) :</label>
                <textarea id="custom-message" placeholder="Ajoutez un message personnel ici..." rows="4" maxlength="300"></textarea>
                <small style="color: #666; display: block; text-align: right; margin-top: 5px;">
                    <span id="char-count">0</span>/300 caract√®res
                </small>
            </div>
            <div class="buttons">
                <button id="prev-2" class="btn btn-prev"><i class="fas fa-arrow-left"></i> Pr√©c√©dent</button>
                <button id="next-2" class="btn btn-next">Aper√ßu </button>
            </div>
        </div>

        <!-- √âtape 3 : Aper√ßu et envoi -->
        <div id="step-3" class="step">
            <h2 class="step-title"><i>3</i> Aper√ßu et envoi</h2>
            <button class="edit-voeux-btn" id="edit-preview-btn">
                <i class="fas fa-edit"></i> Modifier les v≈ìux
            </button>
            
            <!-- Container pour l'affichage utilisateur -->
            <div class="preview-container">
                <div id="voeux-preview" class="voeux-preview">
                    <!-- Le contenu des v≈ìux sera g√©n√©r√© ici -->
                </div>
            </div>
            
            <!-- Container cach√© pour la capture (identique au preview) -->
            <div id="capture-area" style="display: none;">
                <div class="capture-container">
                    <div id="capture-preview" class="voeux-preview">
                        <!-- Le contenu des v≈ìux pour la capture sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
            
            <p style="text-align: center; margin-top: 20px; color: #666;">
                <i class="fas fa-info-circle"></i> T√©l√©chargez l'aper√ßu ou envoyez directement via WhatsApp.
            </p>
            <div class="buttons">
                <button id="prev-3" class="btn btn-prev"><i class="fas fa-arrow-left"></i> Pr√©c√©dent</button>
                <button id="modify-btn" class="btn btn-modify"><i class="fas fa-edit"></i> Modifier</button>
                <button id="download-btn" class="btn btn-download"><i class="fas fa-download"></i> T√©l√©charger</button>
                <button id="send-btn" class="btn btn-send"><i class="fab fa-whatsapp"></i> WhatsApp</button>
            </div>
        </div>

        <!-- Modal pour modifier les v≈ìux -->
        <div class="edit-modal" id="edit-modal">
            <div class="edit-modal-content">
                <div class="edit-modal-header">
                    <h2>Modifier les v≈ìux</h2>
                    <button class="close-modal" id="close-modal">&times;</button>
                </div>
                <div id="edit-content">
                    <!-- Contenu dynamique pour l'√©dition -->
                </div>
            </div>
        </div>

        <footer>
            <p>Cr√©ateur de V≈ìux 2026 ‚Ä¢ Fait avec <i class="fas fa-heart" style="color: #e74c3c;"></i> pour vos c√©l√©brations du Nouvel An</p>
        </footer>
    </div>

    <script>
        // Variables globales
        let selectedVoeuxType = '';
        let recipientName = '';
        let customMessage = '';
        let currentStep = 1;
        let currentEditType = '';

        // Mod√®les de v≈ìux modifiables
        let voeuxTemplates = {
            familial: {
                title: "Familial & Classique",
                description: "Parfait pour la famille et les proches",
                content: `√Ä quelques minutes de 2026, je voulais vous envoyer tout mon amour et mes plus tendres pens√©es. Que cette nouvelle ann√©e vous apporte avant tout la sant√©, de doux bonheurs au quotidien et la r√©alisation de vos petits et grands projets.

Je pense tr√®s fort √† vous en ce d√©but d'ann√©e.

Bonne ann√©e 2026 ! Je vous embrasse tr√®s fort.`
            },
            amical: {
                title: "Amical & Original",
                description: "Pour vos amis, ton original et chaleureux",
                content: `23h. La derni√®re heure de 2025 s'√©coule. J'en profite pour te chuchoter, avant le grand chahut de minuit, tous mes v≈ìux pour toi pour 2026 : des rires qui r√©sonnent, des surprises qui enchantent, et un chemin illumin√© de belles rencontres et d'espoirs.

Pr√©pare-toi √† accueillir la nouvelle ann√©e ! Elle arrive, et je te souhaite qu'elle soit fabuleuse.

Bonne ann√©e mon ami(e) ! ü•Ç‚ú®`
            },
            couple: {
                title: "Romantique",
                description: "Pour votre partenaire, doux et √©mouvant",
                content: `√Ä l'instant o√π l'ann√©e bascule, je veux que tu saches que mon plus beau v≈ìu pour 2026, c'est de pouvoir partager encore de merveilleux moments √† tes c√¥t√©s. Que cette nouvelle aventure qui commence t'apporte tout le bonheur que tu m√©rites.

√Ä nous deux, 2026 ! Je t'aime. Bonne ann√©e mon amour/ch√©ri(e). ‚ù§Ô∏è`
            },
            professionnel: {
                title: "Professionnel",
                description: "Pour vos coll√®gues et relations professionnelles",
                content: `Alors que nous nous appr√™tons √† tourner la page sur 2025, je tenais √† vous adresser mes v≈ìux les plus sinc√®res pour l'ann√©e 2026. Que celle-ci soit porteuse de succ√®s, de r√©alisations professionnelles et de belles opportunit√©s.

Je vous souhaite √©galement une excellente sant√© et beaucoup de bonheur dans votre vie personnelle.

Bonne et heureuse ann√©e 2026 ! ü•Ç`
            }
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // √âtape 1 : S√©lection du type de v≈ìux
            const voeuxOptions = document.querySelectorAll('.voeux-option');
            voeuxOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    // Ne pas s√©lectionner si on clique sur le badge d'√©dition
                    if (!e.target.closest('.edit-badge')) {
                        // Retirer la s√©lection pr√©c√©dente
                        voeuxOptions.forEach(opt => opt.classList.remove('selected'));
                        // Ajouter la s√©lection √† l'option cliqu√©e
                        this.classList.add('selected');
                        selectedVoeuxType = this.dataset.type;
                    }
                });
            });

            // Gestion des badges d'√©dition
            document.querySelectorAll('.edit-badge').forEach(badge => {
                badge.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const type = this.dataset.editType;
                    openEditModal(type);
                });
            });

            // √âtape 2 : Personnalisation
            const recipientNameInput = document.getElementById('recipient-name');
            const customMessageInput = document.getElementById('custom-message');
            const charCount = document.getElementById('char-count');

            recipientNameInput.addEventListener('input', function() {
                recipientName = this.value.trim();
            });

            customMessageInput.addEventListener('input', function() {
                customMessage = this.value;
                charCount.textContent = customMessage.length;
            });

            // Navigation entre les √©tapes
            document.getElementById('next-1').addEventListener('click', function() {
                if (selectedVoeuxType) {
                    goToStep(2);
                } else {
                    alert('Veuillez s√©lectionner un type de v≈ìux');
                }
            });

            document.getElementById('prev-2').addEventListener('click', function() {
                goToStep(1);
            });

            document.getElementById('next-2').addEventListener('click', function() {
                if (recipientName) {
                    goToStep(3);
                    updatePreview();
                } else {
                    alert('Veuillez saisir le nom du destinataire');
                }
            });

            document.getElementById('prev-3').addEventListener('click', function() {
                goToStep(2);
            });

            // Bouton pour modifier l'aper√ßu
            document.getElementById('edit-preview-btn').addEventListener('click', function() {
                openEditModal(selectedVoeuxType);
            });

            // Bouton pour modifier (retour √† l'√©tape 1)
            document.getElementById('modify-btn').addEventListener('click', function() {
                goToStep(1);
            });

            // Bouton de t√©l√©chargement
            document.getElementById('download-btn').addEventListener('click', downloadPreview);

            // Bouton d'envoi WhatsApp
            document.getElementById('send-btn').addEventListener('click', sendViaWhatsApp);

            // Modal d'√©dition
            document.getElementById('close-modal').addEventListener('click', closeEditModal);
        });

        // Fonction pour naviguer entre les √©tapes
        function goToStep(stepNumber) {
            // Masquer toutes les √©tapes
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Afficher l'√©tape cible
            document.getElementById(`step-${stepNumber}`).classList.add('active');
            
            // Mettre √† jour les indicateurs de progression
            document.querySelectorAll('.step-dot').forEach(dot => {
                dot.classList.remove('active');
                if (parseInt(dot.dataset.step) <= stepNumber) {
                    dot.classList.add('active');
                }
            });
            
            currentStep = stepNumber;
        }

        // Fonction pour mettre √† jour l'aper√ßu
        function updatePreview() {
            updateDisplayPreview();
            updateCapturePreview();
        }

        // Mettre √† jour l'aper√ßu visible
        function updateDisplayPreview() {
            const previewElement = document.getElementById('voeux-preview');
            previewElement.innerHTML = generatePreviewHTML();
        }

        // Mettre √† jour l'aper√ßu pour la capture
        function updateCapturePreview() {
            const captureElement = document.getElementById('capture-preview');
            captureElement.innerHTML = generatePreviewHTML();
        }

        // G√©n√©rer le HTML pour l'aper√ßu
        function generatePreviewHTML() {
            let previewHTML = '';
            
            // Salutation avec le nom
            previewHTML += `<p style="font-size: 1.2rem; margin-bottom: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Cher(e) <span class="recipient-name" style="font-weight: bold; color: #0c2461;">${recipientName || '[Nom]'}</span>,</p>`;
            
            // V≈ìux s√©lectionn√©s
            if (selectedVoeuxType && voeuxTemplates[selectedVoeuxType]) {
                previewHTML += `<div style="white-space: pre-line; margin-bottom: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 1.1rem; line-height: 1.6;">${voeuxTemplates[selectedVoeuxType].content}</div>`;
            }
            
            // Message personnalis√© si fourni
            if (customMessage) {
                previewHTML += `<div style="background-color: #f0f5ff; padding: 15px; border-radius: 10px; border-left: 4px solid #4a69bd; margin: 15px 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <p style="font-style: italic; margin: 0; font-size: 1.1rem;">${customMessage}</p>
                </div>`;
            }
            
            // Signature
            previewHTML += `<div style="margin-top: 25px; text-align: right; border-top: 1px solid #ddd; padding-top: 15px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                <p style="font-weight: bold; font-size: 1.3rem; color: #0c2461; margin-bottom: 5px;">Bonne ann√©e 2026 ! </p>
                <p style="color: #666; font-size: 0.9rem;">Cr√©√© par Erwin </p>
            </div>`;
            
            return previewHTML;
        }

        // Fonction pour ouvrir le modal d'√©dition
        function openEditModal(type) {
            currentEditType = type;
            const modal = document.getElementById('edit-modal');
            const editContent = document.getElementById('edit-content');
            
            // Remplir le contenu du modal
            let editHTML = `
                <h3 style="color: #0c2461; margin-bottom: 15px;">Modifier les v≈ìux "${voeuxTemplates[type].title}"</h3>
                <div class="form-group">
                    <label for="edit-template-content">Contenu des v≈ìux :</label>
                    <textarea id="edit-template-content" rows="12" style="font-family: monospace;">${voeuxTemplates[type].content}</textarea>
                    <small style="color: #666;">Vous pouvez modifier librement le texte. Les sauts de ligne seront conserv√©s.</small>
                </div>
                <div class="edit-buttons">
                    <button class="edit-btn edit-btn-cancel" id="cancel-edit">Annuler</button>
                    <button class="edit-btn edit-btn-save" id="save-edit">Enregistrer</button>
                </div>
            `;
            
            editContent.innerHTML = editHTML;
            modal.classList.add('active');
            
            // Ajouter les √©v√©nements pour les boutons du modal
            document.getElementById('cancel-edit').addEventListener('click', closeEditModal);
            document.getElementById('save-edit').addEventListener('click', saveEditedTemplate);
        }

        // Fonction pour fermer le modal d'√©dition
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // Fonction pour sauvegarder les modifications
        function saveEditedTemplate() {
            const newContent = document.getElementById('edit-template-content').value;
            
            if (newContent.trim() === '') {
                alert('Le contenu ne peut pas √™tre vide');
                return;
            }
            
            // Mettre √† jour le mod√®le
            voeuxTemplates[currentEditType].content = newContent;
            
            // Si le type √©dit√© est celui actuellement s√©lectionn√©, mettre √† jour l'aper√ßu
            if (currentEditType === selectedVoeuxType && currentStep === 3) {
                updatePreview();
            }
            
            // Fermer le modal
            closeEditModal();
            
            // Afficher une confirmation
            alert('Les v≈ìux ont √©t√© modifi√©s avec succ√®s !');
        }

        // Fonction pour t√©l√©charger l'aper√ßu (CORRIG√âE pour mobile)
        function downloadPreview() {
            const captureArea = document.getElementById('capture-area');
            const captureContainer = captureArea.querySelector('.capture-container');
            
            // Afficher temporairement la zone de capture
            captureArea.style.display = 'block';
            
            // S'assurer que le contenu est √† jour
            updateCapturePreview();
            
            // Afficher un message pendant le traitement
            const originalText = document.getElementById('download-btn').innerHTML;
            document.getElementById('download-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√©n√©ration...';
            document.getElementById('download-btn').disabled = true;
            
            // D√©terminer la largeur optimale selon l'appareil
            const isMobile = window.innerWidth <= 768;
            const scale = isMobile ? 1.5 : 2;
            const width = isMobile ? 600 : 800;
            
            // Configuration optimis√©e pour html2canvas
            const options = {
                scale: scale,
                width: width,
                backgroundColor: '#f8f9fa',
                useCORS: true,
                allowTaint: false,
                logging: false,
                removeContainer: true,
                imageTimeout: 15000,
                onclone: function(clonedDoc) {
                    // Assurer que les styles sont corrects dans le clone
                    const clonedContainer = clonedDoc.querySelector('.capture-container');
                    if (clonedContainer) {
                        clonedContainer.style.width = width + 'px';
                        clonedContainer.style.maxWidth = width + 'px';
                        clonedContainer.style.margin = '0 auto';
                        clonedContainer.style.padding = '40px';
                    }
                }
            };
            
            // Capturer avec retry en cas d'√©chec
            captureWithRetry(captureContainer, options, 3)
                .then(canvas => {
                    // Cr√©er un lien de t√©l√©chargement
                    const link = document.createElement('a');
                    const fileName = `Voeux-2026-${recipientName || 'destinataire'}-${Date.now()}.png`;
                    link.download = fileName;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    
                    // D√©clencher le t√©l√©chargement
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Masquer √† nouveau la zone de capture
                    captureArea.style.display = 'none';
                    
                    // Restaurer le bouton
                    document.getElementById('download-btn').innerHTML = originalText;
                    document.getElementById('download-btn').disabled = false;
                    
                    // Afficher une confirmation
                    alert('Vos v≈ìux ont √©t√© t√©l√©charg√©s avec succ√®s !');
                })
                .catch(error => {
                    console.error('Erreur lors de la g√©n√©ration de l\'image:', error);
                    
                    // Masquer √† nouveau la zone de capture
                    captureArea.style.display = 'none';
                    
                    // Essayer une m√©thode alternative
                    alert('Utilisation de la m√©thode alternative...');
                    fallbackDownload();
                    
                    // Restaurer le bouton
                    document.getElementById('download-btn').innerHTML = originalText;
                    document.getElementById('download-btn').disabled = false;
                });
        }

        // Fonction avec retry pour html2canvas
        function captureWithRetry(element, options, retries) {
            return new Promise((resolve, reject) => {
                function attempt(remainingRetries) {
                    html2canvas(element, options)
                        .then(resolve)
                        .catch(error => {
                            if (remainingRetries > 0) {
                                console.log(`Nouvel essai... (${remainingRetries} restants)`);
                                // Attendre un peu avant de r√©essayer
                                setTimeout(() => attempt(remainingRetries - 1), 1000);
                            } else {
                                reject(error);
                            }
                        });
                }
                attempt(retries);
            });
        }

        // M√©thode alternative si html2canvas √©choue
        function fallbackDownload() {
            // Cr√©er une image simple avec le texte
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Taille du canvas
            canvas.width = 800;
            canvas.height = 600;
            
            // Fond
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Bordures
            ctx.strokeStyle = '#4a69bd';
            ctx.lineWidth = 2;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            
            // Texte
            ctx.fillStyle = '#0c2461';
            ctx.font = 'bold 24px Arial';
            ctx.fillText(`Cher(e) ${recipientName || 'Destinataire'},`, 50, 80);
            
            ctx.fillStyle = '#333';
            ctx.font = '18px Arial';
            
            // Message principal (tronqu√© pour l'exemple)
            const message = selectedVoeuxType && voeuxTemplates[selectedVoeuxType] 
                ? voeuxTemplates[selectedVoeuxType].content.substring(0, 100) + '...' 
                : 'Vos v≈ìux personnalis√©s ici...';
            
            ctx.fillText(message, 50, 120);
            
            // Signature
            ctx.fillStyle = '#0c2461';
            ctx.font = 'bold 28px Arial';
            ctx.fillText('Bonne ann√©e 2026 ! üéâ', canvas.width - 300, canvas.height - 50);
            
            // T√©l√©charger
            const link = document.createElement('a');
            link.download = `Voeux-2026-${recipientName || 'destinataire'}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // Fonction pour envoyer via WhatsApp
        function sendViaWhatsApp() {
            if (!recipientName) {
                alert('Veuillez d\'abord remplir le nom du destinataire');
                goToStep(2);
                return;
            }
            
            // Construire le message WhatsApp
            let whatsappMessage = `Cher(e) ${recipientName},%0A%0A`;
            
            // Ajouter les v≈ìux
            if (selectedVoeuxType && voeuxTemplates[selectedVoeuxType]) {
                whatsappMessage += voeuxTemplates[selectedVoeuxType].content.replace(/\n/g, '%0A');
            }
            
            // Ajouter le message personnalis√© s'il existe
            if (customMessage) {
                whatsappMessage += `%0A%0A${customMessage}`;
            }
            
            // Ajouter la signature
            whatsappMessage += `%0A%0ABonne ann√©e 2026 ! üéâ`;
            
            // Ouvrir WhatsApp avec le message pr√©-rempli
            const whatsappUrl = `https://wa.me/?text=${whatsappMessage}`;
            window.open(whatsappUrl, '_blank');
            
            // Optionnel: Afficher un message de confirmation
            alert(`Vos v≈ìux sont pr√™ts √† √™tre envoy√©s √† ${recipientName} ! WhatsApp va s'ouvrir. Il ne vous reste plus qu'√† s√©lectionner le contact et appuyer sur "Envoyer".`);
        }
    </script>
</body>
</html>